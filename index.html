<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²æ—ç¸£å…¬æ­£è½‰å‹è„†å¼±åº¦åœ–è³‡å¹³å°-äºæ´²å¤§å­¸</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- æ¨£å¼è¨­å®š --- */
        :root {
            --primary-color: #2d3436;
            --accent-color: #e74c3c;
            --bg-light: #f5f6fa;
            --panel-bg: #ffffff;
            --footer-height: 35px; /* å®šç¾© footer é«˜åº¦ */
            --header-height: 55px; /* å®šç¾© header é«˜åº¦ */
        }

        /* ä½ˆå±€èª¿æ•´ï¼šç¢ºä¿ Header + Main + Footer å‰›å¥½å¡«æ»¿ 100vh */
        body { margin: 0; padding: 0; font-family: 'Microsoft JhengHei', sans-serif; background: var(--bg-light); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Header */
        header { flex: 0 0 var(--header-height); background: var(--primary-color); color: white; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        header h1 { font-size: 1.2rem; margin: 0; display: flex; align-items: center; }
        header nav button { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; display: flex; align-items: center; gap: 5px; }
        header nav button:hover { background: rgba(255,255,255,0.3); }
        
        /* Main Container (è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“) */
        #main-container { flex: 1; display: flex; position: relative; overflow: hidden; }
        #map { flex: 1; background: #dfe6e9; }
        #dashboard { width: 400px; background: var(--panel-bg); border-left: 1px solid #dcdcdc; display: flex; flex-direction: column; overflow-y: auto; z-index: 999; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
        
        /* Footer (æ–°å¢) */
        footer {
            flex: 0 0 var(--footer-height); /* å›ºå®šé«˜åº¦ */
            background: #2d3436; /* èˆ‡ Header åŒè‰²ç³»ä½†ç¨æ·±æˆ–ç›¸åŒ */
            color: #b2bec3;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 0.8rem;
            border-top: 1px solid #444;
            z-index: 1000;
        }
        footer a { color: #74b9ff; text-decoration: none; transition: color 0.2s; }
        footer a:hover { color: #fff; text-decoration: underline; }

        /* Dashboard Components */
        #selector-panel { padding: 15px; background: #fff; border-bottom: 1px solid #eee; }
        select { width: 100%; padding: 8px; font-size: 1rem; border: 1px solid #ddd; border-radius: 4px; }
        .dash-header { padding: 20px; background: #34495e; color: white; position: relative; }
        .dash-header h2 { margin: 0; font-size: 1.5rem; }
        .dash-header .score-display { position: absolute; right: 20px; top: 20px; text-align: right; }
        .dash-header .score-val { font-size: 2rem; font-weight: bold; line-height: 1; }
        .dash-header .score-label { font-size: 0.7rem; opacity: 0.8; }
        .tag { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; margin-top: 8px; background: rgba(255,255,255,0.2); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
        .dash-body { padding: 15px; }
        .card { background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card h4 { margin: 0 0 10px 0; color: #2c3e50; font-size: 0.95rem; border-left: 3px solid var(--accent-color); padding-left: 8px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; border-bottom: 1px dashed #f0f0f0; padding-bottom: 4px; }
        .stat-val { font-weight: bold; color: #555; }
        .fiscal-box { display: flex; align-items: center; font-weight: bold; font-size: 0.9rem; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }

        /* Legend */
        .legend { background: white; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; color: #333; line-height: 1.4; }
        .legend i { width: 15px; height: 15px; float: left; margin-right: 6px; opacity: 0.8; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        .modal-header { padding: 15px 20px; background: var(--primary-color); color: white; border-top-left-radius: 8px; border-top-right-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px 30px; overflow-y: auto; max-height: 70vh; }
        .close { color: white; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #ddd; }
        
        .concept-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .concept-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; }
        .concept-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .concept-title { font-weight: bold; color: #2d3436; margin-bottom: 5px; font-size: 1.1rem; }
        .concept-desc { font-size: 0.9rem; color: #636e72; line-height: 1.4; }
        .formula-box { background: #eef2f3; padding: 15px; border-radius: 6px; text-align: center; font-weight: bold; color: #2d3436; margin: 20px 0; font-size: 1.2rem; border-left: 5px solid #3498db; }
        .help-text { line-height: 1.6; color: #444; margin-bottom: 15px; }

        @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        @media (max-width: 768px) { .concept-grid { grid-template-columns: 1fr; } #dashboard { width: 100%; height: 40%; position: absolute; bottom: 0; } #main-container { flex-direction: column; } footer { flex-direction: column; height: auto; padding: 10px; text-align: center; gap: 5px; } }

    </style>
</head>
<body>

    <header>
        <h1>é›²æ—ç¸£å…¬æ­£è½‰å‹è„†å¼±åº¦åœ–è³‡å¹³å°</h1>
        <nav>
            <button id="infoBtn">æŒ‡æ¨™è§£è®€èªªæ˜</button>
        </nav>
    </header>

    <div id="main-container">
        <div id="map"></div>

        <div id="dashboard">
            <div id="selector-panel">
                <label style="font-size: 0.85rem; color: #777;">å¿«é€Ÿè·³è½‰è‡³é„‰é®ï¼š</label>
                <select id="townSelect" onchange="selectTownFromDropdown(this.value)">
                    <option value="">-- è«‹é¸æ“‡æˆ–é»æ“Šåœ°åœ– --</option>
                    </select>
            </div>

            <div id="empty-state" style="padding: 50px 20px; text-align: center; color: #b2bec3;">
                <div style="font-size: 3rem;"></div>
                <h3>æ¢ç´¢å…¨ç¸£è„†å¼±åº¦</h3>
                <p>é»æ“Šåœ°åœ–åœ“é»ï¼ŒæŸ¥çœ‹é›²æ— 20 é„‰é®åœ¨<br>ã€Œå»ç¢³åŒ–ã€èˆ‡ã€Œè¾²é›»å…±ç”Ÿã€ä¸‹çš„é¢¨éšªã€‚</p>
            </div>

            <div id="data-view" style="display: none;">
                <div class="dash-header">
                    <h2 id="d-name">é„‰é®å</h2>
                    <span class="tag" id="d-type">é¡å‹</span>
                    <div class="score-display">
                        <div class="score-val" id="d-score">--</div>
                        <div class="score-label">ç¶œåˆè„†å¼±åº¦</div>
                    </div>
                </div>

                <div class="dash-body">
                    <div class="card">
                        <h4> ä¸‰ç¶­è„†å¼±æ€§çµæ§‹</h4>
                        <canvas id="radarChart" height="180"></canvas>
                        <div style="font-size: 0.75rem; text-align: center; color: #888; margin-top: 5px;">* é¢ç©è¶Šå¤§ä»£è¡¨è©²ç¶­åº¦é¢¨éšªè¶Šé«˜</div>
                    </div>

                    <div class="card">
                        <h4>é—œéµé¢¨éšªé©…å‹•å› å­</h4>
                        <div id="d-drivers"></div>
                    </div>

                    <div class="card">
                        <h4>è²¡æ”¿èª¿é©èƒ½åŠ›</h4>
                        <div class="fiscal-box" id="d-fiscal-status"></div>
                        <p id="d-fiscal-desc" style="font-size: 0.8rem; color: #666; margin: 5px 0 0 0;"></p>
                    </div>

                    <div class="card" style="background: #f0fdf4; border-left-color: #27ae60;">
                        <h4>AI æ”¿ç­–å»ºè­°</h4>
                        <div id="d-policy" style="font-size: 0.9rem; line-height: 1.5; color: #2d3436;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div>
            &copy; 2025 <strong>äºæ´²å¤§å­¸</strong> | Beta v1.0
        </div>
        <div>
            è³‡æ–™ä¾†æºï¼š
            <a href="https://data.gov.tw/" target="_blank">æ”¿åºœè³‡æ–™é–‹æ”¾å¹³è‡º</a> â€¢ 
            <a href="#" onclick="return false;">é›²æ—ç¸£æ”¿åºœ</a> â€¢ 
            <a href="#" onclick="return false;">ç¶“æ¿Ÿéƒ¨èƒ½æºç½²</a>
        </div>
        <div style="opacity: 0.7; font-size: 0.75rem;">
            Designed for Research & Policy Analysis
        </div>
    </footer>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“˜ ä¸‰ç¶­è„†å¼±åº¦åˆ†ææ¨¡å‹èªªæ˜</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="help-text">
                    æœ¬ç³»çµ±æ¡ç”¨åœ‹éš›é€šç”¨çš„è„†å¼±åº¦è©•ä¼°æ¡†æ¶ï¼Œå°‡ã€Œå…¬æ­£è½‰å‹ã€ä¸­çš„é¢¨éšªæ‹†è§£ç‚ºä¸‰å€‹ç¶­åº¦ã€‚
                    ç‚ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘å€‘å¯ä»¥ç”¨<strong>ã€Œäººé«”å¥åº·ã€</strong>ä¾†åšæ¯”å–»ï¼š
                </p>
                
                <div class="formula-box">
                    è„†å¼±åº¦ = (æ›éœ²åº¦ + æ•æ„Ÿåº¦) - èª¿é©èƒ½åŠ›
                </div>

                <div class="concept-grid">
                    <div class="concept-card">
                        <span class="concept-icon">ğŸŒ©ï¸</span>
                        <div class="concept-title">æ›éœ²åº¦ (Exposure)</div>
                        <div class="concept-desc" style="color: #e74c3c; font-weight: bold;">æ¯”å–»ï¼šå¤–åœ¨çš„ç—…æ¯’é‡</div>
                        <div class="concept-desc" style="margin-top:5px; font-size:0.85rem;">
                            æŒ‡é„‰é®é¢è‡¨ã€Œè½‰å‹è¡æ“Šã€çš„ç›´æ¥ç¨‹åº¦ã€‚<br>
                            ä¾‹å¦‚ï¼šéº¥å¯®é¢å°å»ç¢³åŒ–å£“åŠ›ã€å£æ¹–é¢å°å…‰é›»é–‹ç™¼å£“åŠ›ã€‚
                        </div>
                    </div>
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ¤’</span>
                        <div class="concept-title">æ•æ„Ÿåº¦ (Sensitivity)</div>
                        <div class="concept-desc" style="color: #e67e22; font-weight: bold;">æ¯”å–»ï¼šå€‹äººçš„å…ç–«åŠ›å·®</div>
                        <div class="concept-desc" style="margin-top:5px; font-size:0.85rem;">
                            æŒ‡é„‰é®å…§åœ¨çš„ã€Œé«”è³ªå¼±é»ã€ã€‚<br>
                            ä¾‹å¦‚ï¼šäººå£è€åŒ–åš´é‡ã€ä½æ”¶å…¥æˆ¶å¤šã€ç”¢æ¥­éæ–¼å–®ä¸€ï¼Œä¸€å—å‚·å°±å¾ˆé›£å¥½ã€‚
                        </div>
                    </div>
                    <div class="concept-card">
                        <span class="concept-icon">ğŸ’Š</span>
                        <div class="concept-title">èª¿é©èƒ½åŠ› (Adaptive)</div>
                        <div class="concept-desc" style="color: #27ae60; font-weight: bold;">æ¯”å–»ï¼šæ‰‹é‚Šçš„è—¥ç‰©èˆ‡é†«ç”Ÿ</div>
                        <div class="concept-desc" style="margin-top:5px; font-size:0.85rem;">
                            æŒ‡é„‰é®æ“æœ‰çš„ã€Œæ‡‰å°è³‡æºã€ã€‚<br>
                            ä¾‹å¦‚ï¼šåœ°æ–¹è²¡æ”¿æ˜¯å¦å……è£•ã€æ˜¯å¦æœ‰è·è¨“ä¸­å¿ƒã€é†«ç™‚è³‡æºæ˜¯å¦è¶³å¤ ã€‚
                        </div>
                    </div>
                </div>

                <h4>ğŸ“ˆ å¦‚ä½•è§£è®€é›·é”åœ–ï¼Ÿ</h4>
                <p class="help-text">
                    åœ¨å³å´å„€è¡¨æ¿çš„é›·é”åœ–ä¸­ï¼Œæˆ‘å€‘å±•ç¤ºäº†é€™ä¸‰å€‹ç¶­åº¦ã€‚
                    <ul>
                        <li><strong>åœ–å½¢é¢ç©è¶Šå¤§</strong>ï¼šä»£è¡¨è©²é„‰é®çš„ç¶œåˆè„†å¼±é¢¨éšªè¶Šé«˜ã€‚</li>
                        <li><strong>èª¿é©èƒ½åŠ›ç¼ºå£</strong>ï¼šé›·é”åœ–é¡¯ç¤ºçš„æ˜¯ã€Œç¼ºå£ã€ï¼ˆLack of Adaptiveï¼‰ï¼Œæ•¸å€¼è¶Šé«˜ä»£è¡¨èƒ½åŠ›è¶Šå·®ã€‚</li>
                    </ul>
                </p>
                <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 0.9rem; color: #856404;">
                    <strong>ğŸ’¡ æ”¿ç­–å•Ÿç¤ºï¼š</strong> 
                    å°æ–¼<span style="color:#c0392b">é«˜æ›éœ²</span>ä¸”<span style="color:#e67e22">é«˜æ•æ„Ÿ</span>ï¼Œä½†<span style="color:#27ae60">èª¿é©èƒ½åŠ›ä½</span>ï¼ˆæ²’è—¥é†«ï¼‰çš„åœ°å€ï¼ˆå¦‚æ²¿æµ·è€åŒ–é„‰é®ï¼‰ï¼Œä¸­å¤®æ”¿åºœå¿…é ˆæœ€å„ªå…ˆæŠ•å…¥è³‡æºã€‚
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. é›²æ—ç¸£ 20 é„‰é®æ•¸æ“š ---
        const allTownsData = {
            "mailiao": { name: "éº¥å¯®é„‰", coords: [23.752, 120.253], score: 94, type: "ğŸ”´ ç”¢æ¥­å»ç¢³åŒ–ç†±é»", fiscal: "warning", 
                drivers: [{k:"çŸ³åŒ–æ¥­å°±æ¥­",v:"æ¥µé«˜"}, {k:"ç¢³æ’æ”¾é‡",v:"å…¨åœ‹æœ€é«˜"}, {k:"ç’°å¢ƒè² è·",v:"é‡"}],
                policy: "æ¨å‹•ç¢³è²»åœ¨åœ°å›é¥‹æ©Ÿåˆ¶ï¼Œå»ºç«‹ç”¢æ¥­è½‰å‹åŸºé‡‘ï¼Œè¼”å°ä¾›æ‡‰éˆç¶ è‰²åŒ–ã€‚" },
            "taixi": { name: "å°è¥¿é„‰", coords: [23.705, 120.198], score: 88, type: "ğŸŸ¡ ç¶ èƒ½åœŸåœ°è¡çª", fiscal: "danger", 
                drivers: [{k:"äººå£è€åŒ–",v:"æ¥µé«˜"}, {k:"å…‰é›»è¦†è“‹",v:"é«˜"}, {k:"å°±æ¥­æ©Ÿæœƒ",v:"ç¼ºä¹"}],
                policy: "æ¨å‹•ç¶ èƒ½é•·ç…§æ¨¡å¼ï¼Œç¢ºä¿å…‰é›»æ”¶ç›ŠæŒ¹æ³¨ç¤¾å€è€äººç¦åˆ©ã€‚" },
            "sihu": { name: "å››æ¹–é„‰", coords: [23.642, 120.224], score: 82, type: "ğŸ”µ é¢¨é›»/è¾²æ¥­è½‰å‹", fiscal: "danger", 
                drivers: [{k:"äººå£å¤–æµ",v:"é«˜"}, {k:"é¢¨æ©Ÿè­°é¡Œ",v:"æœ‰"}, {k:"è¾²ç”¢åŠ å·¥",v:"å¼±"}],
                policy: "ç™¼å±•æ¿±æµ·é¢¨é›»è§€å…‰èˆ‡è¾²ç”¢åŠ å€¼ï¼Œæå‡åœ°æ–¹ç”¢æ¥­å¤šæ¨£æ€§ã€‚" },
            "kouhu": { name: "å£æ¹–é„‰", coords: [23.581, 120.185], score: 85, type: "ğŸ”µ åœ°å±¤ä¸‹é™·/è¾²é›»", fiscal: "danger", 
                drivers: [{k:"åœ°å±¤ä¸‹é™·",v:"åš´é‡"}, {k:"æ¼é›»å…±ç”Ÿ",v:"é«˜"}, {k:"æ°£å€™é¢¨éšª",v:"é«˜"}],
                policy: "åš´å¯©æ¼é›»å…±ç”Ÿé¤Šæ®–äº‹å¯¦ï¼Œåˆ©ç”¨ç¶ èƒ½è³‡æºæ”¹å–„æ°´åˆ©é˜²æ´ªè¨­æ–½ã€‚" },
            "douliu": { name: "æ–—å…­å¸‚", coords: [23.709, 120.543], score: 45, type: "ğŸŸ¢ æ”¿ç¶“è¡Œæ”¿ä¸­å¿ƒ", fiscal: "success", 
                drivers: [{k:"æœå‹™æ¥­",v:"ç™¼é”"}, {k:"é†«ç™‚è³‡æº",v:"å„ª"}, {k:"æ•™è‚²ç¨‹åº¦",v:"é«˜"}],
                policy: "ä½œç‚ºå€åŸŸè½‰å‹è³‡æºä¸­å¿ƒï¼Œæä¾›å‘¨é‚Šé„‰é®æŠ€è¡“èˆ‡é†«ç™‚æ”¯æ´ã€‚" },
            "huwei": { name: "è™å°¾é®", coords: [23.708, 120.432], score: 48, type: "ğŸŸ¢ äº¤é€š/ç§‘æŠ€ä¸­å¿ƒ", fiscal: "success", 
                drivers: [{k:"é«˜éµäº¤é€š",v:"å„ª"}, {k:"ç§‘æŠ€åœ’å€",v:"æœ‰"}, {k:"é’å¹´äººå£",v:"ç©©"}],
                policy: "çµåˆä¸­ç§‘è³‡æºç™¼å±•ç¶ èƒ½ç ”ç™¼ï¼Œå¸å¼•é’å¹´äººæ‰å›æµã€‚" },
            "dounan": { name: "æ–—å—é®", coords: [23.676, 120.479], score: 55, type: "ğŸŸ¢ ç‰©æµæ¨ç´", fiscal: "success", 
                drivers: [{k:"äº¤é€šç¯€é»",v:"é‡è¦"}, {k:"å•†æ¥­æ´»å‹•",v:"ç©©"}, {k:"äººå£çµæ§‹",v:"è€åŒ–ä¸­"}],
                policy: "ç™¼å±•ä½ç¢³ç‰©æµåœ’å€ï¼Œå¼·åŒ–è¾²ç”¢å†·éˆç³»çµ±ã€‚" },
            "xiluo": { name: "è¥¿èºé®", coords: [23.793, 120.458], score: 65, type: "ğŸŸ  è¾²æ¥­ä¾›æ‡‰éˆæ ¸å¿ƒ", fiscal: "warning", 
                drivers: [{k:"æ°£å€™æ•æ„Ÿ",v:"é«˜"}, {k:"è¾²æ¥­ç¼ºå·¥",v:"åš´é‡"}, {k:"ç§»å·¥ä¾è³´",v:"é«˜"}],
                policy: "å°å…¥æ™ºæ…§è¾²æ¥­è§£æ±ºç¼ºå·¥ï¼Œå¼·åŒ–æ‰¹ç™¼å¸‚å ´é˜²ç½éŸŒæ€§ã€‚" },
            "erlun": { name: "äºŒå´™é„‰", coords: [23.772, 120.415], score: 70, type: "ğŸŸ  å‚³çµ±è¾²æ¥­å€", fiscal: "danger", 
                drivers: [{k:"è¾²æ¥­ç”¢å€¼",v:"é«˜"}, {k:"è‡ªç±Œè²¡æº",v:"ä½"}, {k:"ç¤¾ç¦éœ€æ±‚",v:"é«˜"}],
                policy: "æ¨å‹•è¾²åœ°æ•´åˆèˆ‡æ©Ÿæ¢°ä»£è€•ï¼ŒåŠ å¼·ç¤¾å€é•·ç…§æ“šé»ã€‚" },
            "lunbei": { name: "å´™èƒŒé„‰", coords: [23.759, 120.353], score: 72, type: "ğŸŸ  é…ªè¾²/æ²¼æ°£", fiscal: "warning", 
                drivers: [{k:"ç•œç‰§å»¢æ°´",v:"è­°é¡Œ"}, {k:"æ²¼æ°£ç™¼é›»",v:"æ½›åŠ›é«˜"}, {k:"ç†±ç·Šè¿«",v:"é«˜"}],
                policy: "æ¨å‹•ç•œé›»å…±ç”Ÿå¾ªç’°ç¶“æ¿Ÿå°ˆå€ï¼Œè§£æ±ºç’°ä¿ä¸¦å¢åŠ æ”¶å…¥ã€‚" },
            "tuku": { name: "åœŸåº«é®", coords: [23.676, 120.394], score: 68, type: "ğŸŸ  å‚³çµ±è¾²æ¥­èšè½", fiscal: "danger", 
                drivers: [{k:"äººå£å¤–æµ",v:"æŒçºŒ"}, {k:"ç”¢æ¥­å–®ä¸€",v:"æ˜¯"}, {k:"æ­·å²è³‡æº",v:"æœ‰"}],
                policy: "çµåˆæ­·å²æ–‡åŒ–ç™¼å±•æ…¢åŸè§€å…‰ï¼Œæ¨å‹•åœ°æ–¹å‰µç”Ÿã€‚" },
            "beigang": { name: "åŒ—æ¸¯é®", coords: [23.575, 120.302], score: 60, type: "ğŸŸ  å®—æ•™è§€å…‰", fiscal: "warning", 
                drivers: [{k:"è§€å…‰äººæµ",v:"é«˜"}, {k:"å•†æ¥­ä¾è³´",v:"é‡"}, {k:"æ·¹æ°´æ½›å‹¢",v:"ä¸­"}],
                policy: "ç™¼å±•ä½ç¢³å®—æ•™è§€å…‰ï¼Œè¼”å°ä¼´æ‰‹ç¦®ç”¢æ¥­å‡ç´šã€‚" },
            "yuanchang": { name: "å…ƒé•·é„‰", coords: [23.647, 120.313], score: 78, type: "ğŸŸ  é«˜é½¡è¾²æ¥­å€", fiscal: "danger", 
                drivers: [{k:"è€å¹´äººå£",v:"æ¥µé«˜"}, {k:"é†«ç™‚å¯è¿‘",v:"ä½"}, {k:"äº¤é€š",v:"ä¸ä¾¿"}],
                policy: "å¼·åŒ–ç§»å‹•é†«ç™‚èˆ‡é•·ç…§äº¤é€šæœå‹™ï¼Œä¿éšœé«˜é½¡è¾²æ°‘ç”Ÿæ´»ã€‚" },
            "baozhong": { name: "è¤’å¿ é„‰", coords: [23.716, 120.311], score: 75, type: "ğŸŸ  æœ€å°é„‰é®", fiscal: "danger", 
                drivers: [{k:"è¡Œæ”¿è³‡æº",v:"å°‘"}, {k:"äººå£è¦æ¨¡",v:"æ¥µå°"}, {k:"ç¶“æ¿Ÿè¦æ¨¡",v:"å°"}],
                policy: "èˆ‡é„°è¿‘é„‰é®é€²è¡Œè¡Œæ”¿è³‡æºå…±äº«ï¼Œé™ä½æ²»ç†æˆæœ¬ã€‚" },
            "dongshi": { name: "æ±å‹¢é„‰", coords: [23.676, 120.254], score: 76, type: "ğŸŸ  æ²¿æµ·éæ¸¡", fiscal: "danger", 
                drivers: [{k:"ç•œç‰§ç”¢å€¼",v:"é«˜"}, {k:"ç¦½æµæ„Ÿ",v:"é¢¨éšª"}, {k:"é’å¹´äººå£",v:"å°‘"}],
                policy: "è¼”å°ç¦½èˆå‡ç´šå…‰é›»è¨­æ–½ï¼Œé™ä½ç–«ç—…é¢¨éšªä¸¦å¢ç¶ èƒ½æ”¶ã€‚" },
            "shuilin": { name: "æ°´æ—é„‰", coords: [23.575, 120.246], score: 80, type: "ğŸŸ  åš´é‡è€åŒ–", fiscal: "danger", 
                drivers: [{k:"äººå£è€åŒ–",v:"åš´é‡"}, {k:"ç¨å±…è€äºº",v:"å¤š"}, {k:"ç”¢æ¥­å–®ä¸€",v:"æ˜¯"}],
                policy: "æ‰“é€ å…¨é½¡å‹å–„ç¤¾å€ï¼Œå°å…¥ç§‘æŠ€è¼”åŠ©è€äººç…§è­·ã€‚" },
            "dapi": { name: "å¤§åŸ¤é„‰", coords: [23.641, 120.429], score: 74, type: "ğŸŸ  é…¸èœæ•…é„‰", fiscal: "danger", 
                drivers: [{k:"åŠ å·¥å»¢æ°´",v:"è­°é¡Œ"}, {k:"ç¼ºå·¥",v:"æœ‰"}, {k:"æ·¹æ°´é¢¨éšª",v:"ä¸­"}],
                policy: "å»ºç«‹é…¸èœå°ˆæ¥­åœ’å€é›†ä¸­è™•ç†å»¢æ°´ï¼Œå°å…¥å¾ªç’°ç¶“æ¿Ÿã€‚" },
            "citong": { name: "è¿æ¡é„‰", coords: [23.759, 120.554], score: 62, type: "ğŸŸ  è¿‘éƒŠè¾²æ¥­", fiscal: "warning", 
                drivers: [{k:"éƒ½å¸‚æ“´å¼µ",v:"ä¸­"}, {k:"è¾²æ¥­ç”¢å€¼",v:"ç©©"}, {k:"äº¤é€š",v:"ä¾¿"}],
                policy: "ç™¼å±•éƒ½å¸‚è¿‘éƒŠä¼‘é–’è¾²æ¥­ï¼Œä½œç‚ºæ–—å…­å¾ŒèŠ±åœ’ã€‚" },
            "linnei": { name: "æ—å…§é„‰", coords: [23.759, 120.610], score: 68, type: "ğŸŒ³ æ°´æºä¿è­·", fiscal: "danger", 
                drivers: [{k:"é–‹ç™¼é™åˆ¶",v:"åš´"}, {k:"ç”Ÿæ…‹è³‡æº",v:"è±"}, {k:"ç ‚çŸ³è­°é¡Œ",v:"æœ‰"}],
                policy: "æ¨å‹•ç”Ÿæ…‹è£œå„Ÿï¼Œç™¼å±•ç’°å¢ƒæ•™è‚²èˆ‡ç”Ÿæ…‹æ—…éŠã€‚" },
            "gukeng": { name: "å¤å‘é„‰", coords: [23.643, 120.569], score: 58, type: "ğŸŒ³ è§€å…‰è¾²æ¥­", fiscal: "warning", 
                drivers: [{k:"åœŸçŸ³æµ",v:"æ½›å‹¢"}, {k:"è§€å…‰ç”¢å€¼",v:"é«˜"}, {k:"å±±å€äº¤é€š",v:"é›£"}],
                policy: "å¼·åŒ–å±±å€é˜²ç½éŸŒæ€§ï¼Œæ¨å‹•ç¢³åŒ¯æ—æ¥­èˆ‡æ°¸çºŒè§€å…‰ã€‚" }
        };

        // --- 2. Map Init ---
        const map = L.map('map').setView([23.68, 120.40], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }).addTo(map);

        function getColor(score) {
            return score >= 85 ? '#c0392b' : score >= 75 ? '#d35400' : score >= 65 ? '#f39c12' : score >= 55 ? '#27ae60' : '#2980b9';
        }

        Object.keys(allTownsData).forEach(key => {
            const data = allTownsData[key];
            const option = document.createElement("option");
            option.value = key;
            option.text = `${data.name} (è„†å¼±åº¦: ${data.score})`;
            document.getElementById("townSelect").appendChild(option);

            L.circle(data.coords, {
                color: '#fff', weight: 1, fillColor: getColor(data.score), fillOpacity: 0.85, radius: 1500
            }).addTo(map)
            .bindTooltip(`<b>${data.name}</b>`, { direction: 'top' })
            .on('click', () => selectTownFromDropdown(key));
        });

        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<strong>è„†å¼±åº¦ç­‰ç´š</strong><br>';
            div.innerHTML += '<i style="background: #c0392b"></i> æ¥µé«˜ (85+)<br>';
            div.innerHTML += '<i style="background: #d35400"></i> é«˜ (75-85)<br>';
            div.innerHTML += '<i style="background: #f39c12"></i> ä¸­ (65-75)<br>';
            div.innerHTML += '<i style="background: #27ae60"></i> ä½ (55-65)<br>';
            div.innerHTML += '<i style="background: #2980b9"></i> æ¥µä½ (<55)<br>';
            return div;
        };
        legend.addTo(map);

        // --- 3. Dashboard Logic ---
        let chartInstance = null;

        function selectTownFromDropdown(key) {
            if(!key) return;
            document.getElementById("townSelect").value = key;
            updateDashboard(key);
            map.flyTo(allTownsData[key].coords, 12, { animate: true, duration: 0.8 });
        }

        function updateDashboard(key) {
            const data = allTownsData[key];
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('data-view').style.display = 'block';

            document.getElementById('d-name').innerText = data.name;
            document.getElementById('d-type').innerText = data.type;
            const sEl = document.getElementById('d-score');
            sEl.innerText = data.score;
            sEl.style.color = getColor(data.score);

            document.getElementById('d-drivers').innerHTML = data.drivers.map(d => `<div class="stat-row"><span>${d.k}</span><span class="stat-val">${d.v}</span></div>`).join('');

            const fBox = document.getElementById('d-fiscal-status');
            let fColor = data.fiscal === 'danger' ? '#e74c3c' : (data.fiscal === 'warning' ? '#f39c12' : '#27ae60');
            let fText = data.fiscal === 'danger' ? 'è²¡æ”¿å›°é›£ (ä¾è³´è£œåŠ©)' : (data.fiscal === 'warning' ? 'è²¡æ”¿çµæ§‹è„†å¼±' : 'è²¡æ”¿ç›¸å°ç©©å¥');
            fBox.innerHTML = `<span class="dot" style="background:${fColor}"></span> <span style="color:${fColor}">${fText}</span>`;
            document.getElementById('d-fiscal-desc').innerText = "è²¡æ”¿è‡ªä¸»æ€§å½±éŸ¿è½‰å‹æ‡‰å°èƒ½åŠ›";

            document.getElementById('d-policy').innerText = data.policy;

            let exp = Math.min(100, data.score + 5);
            let sen = Math.min(100, data.score - 5);
            let adap = Math.max(10, 100 - data.score); 
            updateChart([exp, sen, 100-adap]);
        }

        function updateChart(dataArray) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['æ›éœ²åº¦ (Exposure)', 'æ•æ„Ÿåº¦ (Sensitivity)', 'èª¿é©èƒ½åŠ›ç¼ºå£ (Lack of Adaptive)'],
                    datasets: [{
                        label: 'è„†å¼±æ€§', data: dataArray,
                        backgroundColor: 'rgba(231, 76, 60, 0.2)', borderColor: 'rgba(231, 76, 60, 1)',
                        pointBackgroundColor: '#fff', borderWidth: 2
                    }]
                },
                options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- Modal Logic ---
        var modal = document.getElementById("infoModal");
        var btn = document.getElementById("infoBtn");
        var span = document.getElementsByClassName("close")[0];

        btn.onclick = function() { modal.style.display = "block"; }
        span.onclick = function() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) { modal.style.display = "none"; } }

    </script>
</body>
</html>